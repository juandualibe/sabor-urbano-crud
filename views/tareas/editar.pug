extends ../layout

block content
  - var page = 'tareas'
  
  .row.mb-4
    .col-12
      h1.display-6
        i.fas.fa-edit.text-warning.me-3
        | Editar Tarea

  .row
    .col-lg-6
      .card
        .card-body
          if tarea
            form#tareaForm(action=`/api/tareas/${tarea.id}?_method=PUT` method="POST")
              input(type="hidden", name="_method", value="PUT")
              .mb-3
                label.form-label(for="titulo") Título
                input.form-control(type="text", id="titulo", name="titulo", value=tarea.titulo, required)
              .mb-3
                label.form-label(for="descripcion") Descripción
                textarea.form-control(id="descripcion", name="descripcion", rows="4")= tarea.descripcion || ''
              .mb-3
                label.form-label(for="area") Área
                select.form-control(id="area", name="area", required)
                  option(value="gestion_pedidos", selected=tarea.area === 'gestion_pedidos') Gestión Pedidos
                  option(value="control_inventario", selected=tarea.area === 'control_inventario') Control Inventario
              .mb-3
                label.form-label(for="estado") Estado
                select.form-control(id="estado", name="estado", required)
                  option(value="pendiente", selected=tarea.estado === 'pendiente') Pendiente
                  option(value="en_proceso", selected=tarea.estado === 'en_proceso') En Proceso
                  option(value="finalizada", selected=tarea.estado === 'finalizada') Finalizada
              .mb-3
                label.form-label(for="prioridad") Prioridad
                select.form-control(id="prioridad", name="prioridad", required)
                  option(value="alta", selected=tarea.prioridad === 'alta') Alta
                  option(value="media", selected=tarea.prioridad === 'media') Media
                  option(value="baja", selected=tarea.prioridad === 'baja') Baja
              .mb-3
                label.form-label(for="empleadoAsignado") Empleado Asignado
                select.form-control(id="empleadoAsignado", name="empleadoAsignado")
                  option(value="") Sin asignar
                  each emp in empleados
                    option(value=emp.id, selected=tarea.empleadoAsignado === emp.id) #{emp.nombre} #{emp.apellido}
              .mb-3
                label.form-label(for="pedidoAsociado") Pedido Asociado
                input.form-control(type="number", id="pedidoAsociado", name="pedidoAsociado", value=tarea.pedidoAsociado || '')
              .mb-3
                label.form-label(for="observaciones") Observaciones
                textarea.form-control(id="observaciones", name="observaciones", rows="4")= tarea.observaciones || ''
              .d-grid
                button.btn.btn-warning(type="submit")
                  i.fas.fa-save.me-2
                  | Actualizar Tarea
          else
            .alert.alert-danger
              i.fas.fa-exclamation-triangle.me-2
              | Tarea no encontrada
      a.btn.btn-outline-secondary.mt-3(href="/tareas")
        i.fas.fa-arrow-left.me-2
        | Volver
    script.
      console.log('ID de la tarea:', #{tarea.id});
      document.getElementById('tareaForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData);
        if (!data.empleadoAsignado) delete data.empleadoAsignado;
        if (!data.pedidoAsociado) delete data.pedidoAsociado;
        try {
          const response = await fetch(`/api/tareas/${#{tarea.id}}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(Object.fromEntries(Object.entries(data).filter(([key]) => key !== '_method')))
          });
          const result = await response.json();
          if (result.success) {
            alert('Tarea actualizada exitosamente');
            window.location.href = '/tareas';
          } else {
            alert(`Error: ${result.message}`);
          }
        } catch (error) {
          alert('Error al actualizar la tarea');
          console.error('Error:', error);
        }
      });